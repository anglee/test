<!DOCTYPE html>
<html>
<head lang="en">
  <meta charset="UTF-8">
  <title>TEST</title>
  <script src="bower_components/d3/d3.js"></script>
  <script src="bower_components/underscore/underscore.js"></script>
  <style type="text/css">

    body
    {
      padding-top: 50px;
      padding-left: 10px;
    }

    .bar
    {
      fill: teal;
    }

    #chartArea
    {
      width: 1500px;
      height: 500px;
      background: lightblue;
    }
  </style>
</head>
<body>
  <div id="chartArea"></div>
  <script>
    // January = 0
    // February = 1
    // Sunday = 0
    // Saturday = 6
    // Jan 1st, getDate() === 1
    var SUNDAY = 0;
    var SATURDAY = 6;
    var daysInWeek = 7;

    // get what day the first day of the month is
    // Sunday = 0, Saturday = 6
    var getMonthDayOffset = function(year, month) {
      return new Date(year, month, 1).getDay();
    };

    // get how many weeks a given month will occupy
    var getMonthColumnWidth = function(year, month) {
      var begin = new Date(year, month, 1);
      var end = new Date(year, month + 1, 0);
      var days = end.getDate() - begin.getDate() + 1;
      var offset = begin.getDay();
      var weeks = Math.ceil((offset + days) / 7);
      return weeks;
    };

    // if the first week is column zero
    // this function return the start column of the given month
    var getStartColumn = function(year, month) {
      return _.chain(_.range(0, month)).map(function(m) {
        return getMonthColumnWidth(year, m);
      }).reduce(function(sum, w) {
        return sum + w;
      }, 0).value();
    };

    var getMonthLeftShiftable = function(year, month) {
      if (month === 0) {
        return false;
      }
      var start = new Date(year, month, 1);
      return start.getDay() !== SUNDAY;
    };

    // for a given month, return how many months gap before this month can be reduced
    var getColumnReduce = function(year, month) {
      return _.chain(_.range(0, month + 1)).map(function(m) {
        return getMonthLeftShiftable(year, m);
      }).reduce(function(sum, shiftable) {
        return sum + (shiftable ? 1 : 0);
      }, 0).value();
    };

    var svg = d3.select('#chartArea').append('svg')
        .attr('width', 1500)
        .attr('height', 500);

    var rectSize = 18;
    var gapSize = 2;
    var monthGapSize = (rectSize + gapSize) / 2;

    var dataset = _(_.range(1, 365)).map(function(it) {
      return new Date(2014, 0, it);
    });
    window.dataset = dataset;
    svg.selectAll('rect')
        .data(dataset)
        .enter()
        .append('rect')
        .attr('class', 'bar')
        .attr('x', function(d, i) {
          var year = 1900 + d.getYear();
          var month = d.getMonth();
          var offset = getMonthDayOffset(1900 + d.getYear(), d.getMonth());
          var dayInMonth = d.getDate() - 1;
          var dayAfterOffset = dayInMonth + offset;
          var weekNumberInMonth = Math.floor(dayAfterOffset / daysInWeek);
          var monthStartColumn = getStartColumn(year, month);
          return (monthStartColumn + weekNumberInMonth) * (rectSize + gapSize);
              //-  monthGapSize * getColumnReduce(year, month);
        })
        .attr('y', function(d, i) {
          var offset = getMonthDayOffset(1900 + d.getYear(), d.getMonth());
          var t = d.getDate() - 1 + offset;
          return (t % daysInWeek) * (rectSize + gapSize);
        })
        .attr('width', rectSize)
        .attr('height', rectSize);
  </script>
</body>
</html>